USE ROLE ACCOUNTADMIN;

USE WAREHOUSE COMPUTE_WH;
CREATE OR REPLACE database WalmartData;
CREATE OR REPLACE SCHEMA WalmartDataSchema;

CREATE OR REPLACE TABLE DEPARTMENT (
    STORE NUMBER,
    DEPT NUMBER,
    DATE DATE,
    WEEKLY_SALES FLOAT,
    ISHOLIDAY BOOLEAN
);

CREATE OR REPLACE TABLE STORES (
    STORE NUMBER,
    TYPE VARCHAR(25),
    SIZE NUMBER
);


CREATE OR REPLACE TABLE FACT (
  STORE VARCHAR, DATE VARCHAR, TEMPERATURE VARCHAR, FUEL_PRICE VARCHAR,
  MARKDOWN1 VARCHAR, MARKDOWN2 VARCHAR, MARKDOWN3 VARCHAR, MARKDOWN4 VARCHAR, MARKDOWN5 VARCHAR,
  CPI VARCHAR, UNEMPLOYMENT VARCHAR, ISHOLIDAY VARCHAR
);

CREATE OR REPLACE STORAGE INTEGRATION S3_INT
    TYPE = EXTERNAL_STAGE
    STORAGE_PROVIDER = 'S3'
    ENABLED = TRUE
    STORAGE_AWS_ROLE_ARN = 'arn:aws:iam::692701344846:role/WalmartProjectRole'
    STORAGE_ALLOWED_LOCATIONS = ('s3://scd1-data-bucket01/data/walmart/');

 -- -----------------------------------------------


    
-- STORAGE_AWS_IAM_USER_ARN 

-- STORAGE_AWS_EXTERNAL_ID
-- DESC INTEGRATION S3_INT;



CREATE OR REPLACE STAGE EMPLOYEE_DATA.RAW_DATA.S3_STAGE_WALMART
STORAGE_INTEGRATION = S3_INT
URL= 's3://scd1-data-bucket01/data/walmart/';





ls @EMPLOYEE_DATA.RAW_DATA.S3_STAGE_WALMART

USE SCHEMA EMPLOYEE_DATA.RAW_DATA;

show pipes;


CREATE OR REPLACE PIPE EMPLOYEE_DATA.RAW_DATA.MY_WALMART_PIPE AUTO_INGEST = TRUE AS
COPY INTO EMPLOYEE_DATA.RAW_DATA.FACT
FROM @EMPLOYEE_DATA.RAW_DATA.S3_STAGE_WALMART
FILE_FORMAT = (TYPE = 'CSV');



COPY INTO EMPLOYEE_DATA.RAW_DATA.FACT
FROM @EMPLOYEE_DATA.RAW_DATA.S3_STAGE_WALMART
FILE_FORMAT = (TYPE = 'CSV')
ON_ERROR = 'CONTINUE';

COPY INTO EMPLOYEE_DATA.RAW_DATA.DEPARTMENT
FROM @EMPLOYEE_DATA.RAW_DATA.S3_STAGE_WALMART
FILE_FORMAT = (TYPE = 'CSV')
ON_ERROR = 'CONTINUE';


COPY INTO EMPLOYEE_DATA.RAW_DATA.STORES
FROM @EMPLOYEE_DATA.RAW_DATA.S3_STAGE_WALMART
FILE_FORMAT = (TYPE = 'CSV')
ON_ERROR = 'CONTINUE';


