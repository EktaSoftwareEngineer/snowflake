USE ROLE ACCOUNTADMIN;
USE WAREHOUSE COMPUTE_WH;
CREATE OR REPLACE DATABASE WALMART_SOURCE_DB;
CREATE SCHEMA IF NOT EXISTS WALMART_SOURCE_DB.BRONZE;

CREATE OR REPLACE TABLE WALMART_SOURCE_DB.BRONZE.DEPARTMENT (
  Store INT,
  Dept INT,
  Date DATE,
  Weekly_Sales FLOAT,
  IsHoliday BOOLEAN
);

-- Stores Table
CREATE OR REPLACE TABLE WALMART_SOURCE_DB.BRONZE.STORES (
  Store INT,
  Type STRING,
  Size INT
);
-- Fact Table
CREATE OR REPLACE TABLE WALMART_SOURCE_DB.BRONZE.FACT (
  Store INT,
  Date DATE,
  Temperature FLOAT,
  Fuel_Price FLOAT,
  MarkDown1 FLOAT,
  MarkDown2 FLOAT,
  MarkDown3 FLOAT,
  MarkDown4 FLOAT,
  MarkDown5 FLOAT
);

CREATE OR REPLACE STORAGE INTEGRATION S3_INT

  TYPE = EXTERNAL_STAGE

  STORAGE_PROVIDER = 'S3'

  ENABLED = TRUE

  STORAGE_AWS_ROLE_ARN = 'arn:aws:iam::717188664847:role/snowpiperole-walmart'

  STORAGE_ALLOWED_LOCATIONS = ('s3://walmart-projecty/walmart/');

DESC INTEGRATION S3_INT;

CREATE OR REPLACE STAGE WALMART_SOURCE_DB.BRONZE.S3_STAGE

STORAGE_INTEGRATION = S3_INT

URL= 's3://walmart-projecty/walmart/';

CREATE OR REPLACE PIPE WALMART_SOURCE_DB.BRONZE.MY_WALMART_PIPE AUTO_INGEST = TRUE AS
COPY INTO WALMART_SOURCE_DB.BRONZE.FACT
FROM @WALMART_SOURCE_DB.BRONZE.S3_STAGE
FILE_FORMAT = (TYPE = 'CSV');

CREATE OR REPLACE PIPE WALMART_SOURCE_DB.BRONZE.MY_WALMART_PIPE AUTO_INGEST = TRUE AS
COPY INTO WALMART_SOURCE_DB.BRONZE.Stores
FROM @WALMART_SOURCE_DB.BRONZE.S3_STAGE
FILE_FORMAT = (TYPE = 'CSV');

CREATE OR REPLACE PIPE WALMART_SOURCE_DB.BRONZE.MY_WALMART_PIPE AUTO_INGEST = TRUE AS
COPY INTO WALMART_SOURCE_DB.BRONZE.department
FROM @WALMART_SOURCE_DB.BRONZE.S3_STAGE
FILE_FORMAT = (TYPE = 'CSV');

LIST @WALMART_SOURCE_DB.BRONZE.S3_STAGE;



use schema walmart_source_db.bronze;
show pipes;

TRUNCATE TABLE DEPARTMENT;

-- TRUNCATE TABLE STORES;

-- TRUNCATE TABLE FACT;
select * from WALMART_SOURCE_DB.BRONZE.fact;
